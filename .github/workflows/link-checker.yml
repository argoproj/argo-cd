# Broken Link checker
name: Docs Link Checker

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *" # Runs daily

permissions:
  contents: read
  issues: write

jobs:
  linkChecker:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      
      - name: Docs Link Checker # Run Lychee
        id: lychee
        uses: lycheeverse/lychee-action@v2.6.1
        continue-on-error: true
        with:
          args: >
            --accept '100..=103,200..=299,403,429,302'
            --exclude-all-private
            --exclude-loopback
            --exclude-file .lycheeignore
            --timeout 60
            docs/

      
      - name: Generate hash of broken links # Generate hash only if links failed
        id: hash
        if: steps.lychee.outputs.exit_code != '0'
        run: |
          HASH=$(sha256sum lychee/out.md | awk '{print $1}')
          echo "hash=$HASH" >> "$GITHUB_OUTPUT"

      
      - name: Find existing issue # Find existing automated issue
        id: find_issue
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open",
              labels: "automated issue",
              per_page: 100
            });

            const issue = issues.data.find(i =>
              i.title === "Broken Link Detected in Docs"
            );

            if (issue) {
              core.setOutput("exists", "true");
              core.setOutput("number", issue.number);
              core.setOutput("body", issue.body || "");
            } else {
              core.setOutput("exists", "false");
            }

      
      - name: Create new issue # Create new issue if no issue exists
        if: steps.lychee.outputs.exit_code != '0' && steps.find_issue.outputs.exists == 'false'
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: Broken Link Detected in Docs
          content-filepath: ./lychee/out.md
          labels: automated issue, documentation
          body: |
            <!-- lychee-hash: ${{ steps.hash.outputs.hash }} -->

      
      - name: Create new issue if links changed # Create new issue if links changed
        if: >
          steps.lychee.outputs.exit_code != '0' &&
          steps.find_issue.outputs.exists == 'true' &&
          !contains(steps.find_issue.outputs.body, steps.hash.outputs.hash)
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: Broken Link Detected in Docs
          content-filepath: ./lychee/out.md
          labels: automated issue, documentation
          body: |
            <!-- lychee-hash: ${{ steps.hash.outputs.hash }} -->

      - name: Comment on existing issue # Comment if links are unchanged
        if: >
          steps.lychee.outputs.exit_code != '0' &&
          steps.find_issue.outputs.exists == 'true' &&
          contains(steps.find_issue.outputs.body, steps.hash.outputs.hash)
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: Number("${{ steps.find_issue.outputs.number }}"),
              body:
                "**Broken links detected again**\n\n" +
                "No change in affected links.\n\n" +
                "Latest run:\n" +
                context.serverUrl + "/" +
                context.repo.owner + "/" +
                context.repo.repo +
                "/actions/runs/" +
                context.runId
            });
