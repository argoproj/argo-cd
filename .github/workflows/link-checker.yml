# Broken Link checker
name: Docs Link Checker

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *" # Runs once a day

permissions:
  contents: read
  issues: write

jobs:
  linkChecker:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Docs Link Checker # Run lychee
        id: lychee
        uses: lycheeverse/lychee-action@v2.6.1
        continue-on-error: true
        with:
          args: >
            --accept '100..=103,200..=299,302,403,429'
            --exclude-all-private
            --exclude-loopback
            --exclude-file .lycheeignore
            --timeout 60
            docs/

      - name: Exit if no broken links # Stop early if no broken links
        if: steps.lychee.outputs.exit_code == '0'
        run: echo "No broken links detected."

      - name: Compute broken link hash # Compute hash of current broken links
        id: hash
        if: steps.lychee.outputs.exit_code != '0'
        run: |
          HASH=$(sha256sum lychee/out.md | cut -d ' ' -f1)
          echo "hash=$HASH" >> $GITHUB_OUTPUT

      - name: Check existing issue # Fetch existing automated issue + stored hash
        id: check_issue
        if: steps.lychee.outputs.exit_code != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open",
              labels: "automated issue",
              per_page: 100,
            });

            let issueNumber = "";
            let existingHash = "";

            for (const issue of issues) {
              if (issue.title.includes("Broken Link Detected")) {
                issueNumber = issue.number;
                const match = issue.body?.match(/lychee-hash:\s*(\w+)/);
                if (match) {
                  existingHash = match[1];
                }
                break;
              }
            }

            core.setOutput("issue_number", issueNumber);
            core.setOutput("existing_hash", existingHash);

      - name: Create Issue From File # Create NEW issue only if broken links changed
        if: >
          steps.lychee.outputs.exit_code != '0' &&
          steps.hash.outputs.hash != steps.check_issue.outputs.existing_hash
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: Broken Link Detected in Docs
          content-filepath: ./lychee/out.md
          labels: automated issue, documentation, good first issue
          body: |
            <!-- lychee-hash: ${{ steps.hash.outputs.hash }} -->

      - name: Comment on existing issue # Comment on existing issue if same failures persist
        if: >
          steps.lychee.outputs.exit_code != '0' &&
          steps.hash.outputs.hash == steps.check_issue.outputs.existing_hash &&
          steps.check_issue.outputs.issue_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: Number("${{ steps.check_issue.outputs.issue_number }}"),
              body:
                "*Broken links still present*\n\n" +
                "No new broken links detected since the last report.\n\n" +
                context.serverUrl + "/" +
                context.repo.owner + "/" +
                context.repo.repo +
                "/actions/runs/" +
                context.runId
            });