apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: guestbook
spec:
  generators:
  - clusters:
      # The 'values' field can be used to extract data from the cluster secret.
      # In this example, we are extracting the value of the 'mykey' key from the secret's 'data' field.
      # The value will be available in the template as '{{.values.mykey}}'.
      values:
        mykey: '{{index .metadata.annotations "my.annotation"}}'
      selector:
        matchLabels:
          argocd.argoproj.io/secret-type: cluster
  template:
    metadata:
      name: '{{.name}}-guestbook'
      annotations:
        # You can use the value from the secret in the template.
        my-annotation: '{{.values.mykey}}'
    spec:
      project: "default"
      source:
        repoURL: https://github.com/argoproj/argocd-example-apps.git
        targetRevision: HEAD
        path: guestbook
      destination:
        server: '{{.server}}'
        namespace: guestbook
#
# To use this example, you need to create a cluster secret with the following annotation:
#
# apiVersion: v1
# kind: Secret
# metadata:
#   name: my-cluster-secret
#   labels:
#     argocd.argoproj.io/secret-type: cluster
#   annotations:
#     my.annotation: "my-value"
# type: Opaque
# stringData:
#   name: my-cluster
#   server: https://kubernetes.default.svc
#
