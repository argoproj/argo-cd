apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: app-ccm
spec:
  generators:
    - clusters:
        selector:
          matchLabels:
            argocd.argoproj.io/secret-type: cluster
          matchExpressions:
            - key: region
              operator: In
              values: [ "east" ]
            - key: environment
              operator: In
              values: [ "dev" ]
  template:
    metadata:
      name: 'app-{{name}}'
    spec:
      project: project
      source:
        path: 'app'
        repoURL: foo.bar.com/app.git
        targetRevision: HEAD
      destination:
        namespace: not-argocd
        server: '{{server}}'
      syncPolicy:
        automated:
          prune: true
