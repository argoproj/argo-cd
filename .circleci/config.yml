version: 2
jobs:
  build:
    working_directory: /go/src/github.com/argoproj/argo-cd
    docker:
      - image: argoproj/argo-cd-ci-builder:v1.0.0
    steps:
      - checkout
      - restore_cache:
          key: vendor
      - run:
          name: Dependencies
          command: dep ensure
      - run:
          name: Generate code
          command: make codegen
      - run:
          name: Compile production code
          command: make build
      - run:
          name: Lint code
          command: make lint
      - run:
          name: Run unit tests
          command: make test
      - run:
          name: Check nothing has changed
          command: git diff --exit-code
      - run:
          name: Uploading code coverage
          command: bash <(curl -s https://codecov.io/bash) -f coverage.out
          when: always
      - store_test_results:
          path: test-results.xml
      - save_cache:
          key: vendor
          paths:
            - vendor
          when: always
  k3s:
    build:
      working_directory: /go/src/github.com/argoproj/argo-cd
      docker:
        - image: argoproj/argo-cd-ci-builder:v1.0.0
      steps:
        - run:
            name: Start K3S
            command: k3s kubectl get node
workflows:
  version: 2
  workflow:
    jobs:
      - build
      - k3s