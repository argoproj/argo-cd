---
title: Neat-enhancement-idea
authors:
  - "@rrachev" # Authors' github accounts here.
sponsors:
  - TBD        # List all interested parties here.
reviewers:
  - "@alexmt"
  - TBD
approvers:
  - "@alexmt"
  - TBD

creation-date: 2023-08-03
last-updated: 2023-08-03
---

# Different deletion strategy for ArgoCD progressive sync

Currently argocd progressive sync deploy generated applications based on the order that you specified in the applicationset configuration, but when you need to remove all the generated/deployed application it does not follow this order. It keep the argocd application (if it is also generated by the applicationset) and removes all other applications in parallel.

Proposal is related to new functionality of ArgoCD ProggressiveSync that will allow users to configure the exact order in which applications will be removed.
There will be 3 different strategy which could be used: 
* Default (current strategy that ArgoCD use)
* Reverse (this strategy will use the order configured in progressive sync but in reverse order)
* Custom (with this strategy user could provide totally different strategy for the deletion process)

Content:
* [Open Questions](#open-questions)
   
* [Summary](#summary)
* [Motivation](#motivation)
* [Goals](#goals)
    * [[G-1] Deletion strategy in reverse order](#g-1-deletion-strategy-in-reverse-order)
    * [[G-2] Ability to provide custom deletion strategy](#g-2-ability-to-provide-custom-deletion-strategy)
* [Non-Goals](#non-goals)
* [Proposal](#proposal)
    * [Use cases](#use-cases)
        * [[UC-1]: As a user, I would like to configure deletion strategy](#uc-1-as-a-user-i-would-like-to-configure-deletion-strategy)
    * [Security Considerations](#security-considerations)
    * [Risks and Mitigations](#risks-and-mitigations)
    * [Upgrade / Downgrade](#upgrade--downgrade)
* [Drawbacks](#drawbacks)

## Open Questions [optional]

This is where to call out areas of the design that require closure before deciding to implement the
design.


## Summary

ArgoCD can benefit from Deletion strategy related to progressive sync.
Current feature will allow application dependency even in case of the decommission processes.

## Motivation

Current deletion/removal strategy which ArgoCD use works fine if there aren't any dependencies between the different applications.
However, it does not work when there are dependencies between the applications.
This was noticed when some kubernetes core services were deployed in specific order and to be removed in reverse order.

### Goals

All following goals should be achieved in order to conclude this proposal:

#### [G-1] Deletion strategy in reverse order
ArgoCD progressive sync to provide functionality to use deletion strategy but in reverse order of the steps configured in RollingSync strategy. 

#### [G-2] Ability to provide custom deletion strategy
ArgoCD progressive sync to provide functionality specify custom deletion strategy which is different from the steps configured in RollingSync strategy. 


### Non-Goals

TBD

## Proposal

Ability to provide configuration related to the deletion/removal process when progressive sync is used.
It will be useful to have 3  deletion strategy:
* Default (current strategy that ArgoCD use). Here is example if we want to use current deletion strategy to remove everything in parallel and to keep the argocd at the end:
```yaml
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: pricelist
  namespace: argocd
spec:
  generators:
  - list:
      elements:
      - srv: config
        path: applicationsets/rollingsync/apps/pricelist-config
      - srv: db
        path: applicationsets/rollingsync/apps/pricelist-db
      - srv: frontend
        path: applicationsets/rollingsync/apps/pricelist-frontend
  strategy:
    type: RollingSync
### Deletion configuration ###
    deletionSyncStrategy: "default"  # available options to be default/reverse/custom
### Deletion configuration ###
    rollingSync:
      steps:
        - matchExpressions:
            - key: pricelist-component # the "key" is based on the label (below as "pricelist-component: {{srv}}")
              operator: In
              values:
                - config
          #maxUpdate: 100%  # if undefined, all applications matched are updated together (default is 100%)
        - matchExpressions:
            - key: pricelist-component
              operator: In
              values:
                - db
          #maxUpdate: 0      # if 0, no matched applications will be updated
        - matchExpressions:
            - key: pricelist-component
              operator: In
              values:
                - frontend
          #maxUpdate: 10%    # all application matched are rollout no more than the percentage indicates
  template:
    metadata:
      name: 'pricelist-{{srv}}'
      labels:
        pricelist-component: '{{srv}}'
    spec:
      project: default
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        retry:
          limit: 5
          backoff:
            duration: 5s
            maxDuration: 3m0s
            factor: 2
      source:
        repoURL: https://github.com/christianh814/gitops-examples
        targetRevision: main
        path: '{{path}}'
      destination:
        server: https://kubernetes.default.svc
        namespace: pricelist
```

* Reverse (this strategy will use the order configured in progressive sync but in reverse order). Example if we want to use same deletion strategy as we have for the deployment but in reverse order:
```yaml
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: pricelist
  namespace: argocd
spec:
  generators:
  - list:
      elements:
      - srv: config
        path: applicationsets/rollingsync/apps/pricelist-config
      - srv: db
        path: applicationsets/rollingsync/apps/pricelist-db
      - srv: frontend
        path: applicationsets/rollingsync/apps/pricelist-frontend
  strategy:
    type: RollingSync
### Deletion configuration ###
    deletionSyncStrategy: "reverse"  # available options to be default/reverse/custom
### Deletion configuration ###
    rollingSync:
      steps:
        - matchExpressions:
            - key: pricelist-component # the "key" is based on the label (below as "pricelist-component: {{srv}}")
              operator: In
              values:
                - config
          #maxUpdate: 100%  # if undefined, all applications matched are updated together (default is 100%)
        - matchExpressions:
            - key: pricelist-component
              operator: In
              values:
                - db
          #maxUpdate: 0      # if 0, no matched applications will be updated
        - matchExpressions:
            - key: pricelist-component
              operator: In
              values:
                - frontend
          #maxUpdate: 10%    # all application matched are rollout no more than the percentage indicates
  template:
    metadata:
      name: 'pricelist-{{srv}}'
      labels:
        pricelist-component: '{{srv}}'
    spec:
      project: default
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        retry:
          limit: 5
          backoff:
            duration: 5s
            maxDuration: 3m0s
            factor: 2
      source:
        repoURL: https://github.com/christianh814/gitops-examples
        targetRevision: main
        path: '{{path}}'
      destination:
        server: https://kubernetes.default.svc
        namespace: pricelist  
```

* Custom (with this strategy user could provide totally different strategy for the deletion process). example if we want to use custom/different deletion strategy:
```yaml
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: pricelist
  namespace: argocd
spec:
  generators:
  - list:
      elements:
      - srv: config
        path: applicationsets/rollingsync/apps/pricelist-config
      - srv: db
        path: applicationsets/rollingsync/apps/pricelist-db
      - srv: frontend
        path: applicationsets/rollingsync/apps/pricelist-frontend
  strategy:
    type: RollingSync
### Deletion configuration ###
    deletionSyncStrategy: "custom"  # available options to be default/reverse/custom
    deletionSync:
      steps:
        - matchExpressions:
            - key: pricelist-component # the "key" is based on the label (below as "pricelist-component: {{srv}}")
              operator: In
              values:
                - config
          #maxUpdate: 100%  # if undefined, all applications matched are updated together (default is 100%)
        - matchExpressions:
            - key: pricelist-component
              operator: In
              values:
                - frontend
          #maxUpdate: 10%    # all application matched are rollout no more than the percentage indicates
        - matchExpressions:
            - key: pricelist-component
              operator: In
              values:
                - db
          #maxUpdate: 0      # if 0, no matched applications will be updated
### Deletion configuration ###
    rollingSync:
      steps:
        - matchExpressions:
            - key: pricelist-component # the "key" is based on the label (below as "pricelist-component: {{srv}}")
              operator: In
              values:
                - config
          #maxUpdate: 100%  # if undefined, all applications matched are updated together (default is 100%)
        - matchExpressions:
            - key: pricelist-component
              operator: In
              values:
                - db
          #maxUpdate: 0      # if 0, no matched applications will be updated
        - matchExpressions:
            - key: pricelist-component
              operator: In
              values:
                - frontend
          #maxUpdate: 10%    # all application matched are rollout no more than the percentage indicates
  template:
    metadata:
      name: 'pricelist-{{srv}}'
      labels:
        pricelist-component: '{{srv}}'
    spec:
      project: default
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        retry:
          limit: 5
          backoff:
            duration: 5s
            maxDuration: 3m0s
            factor: 2
      source:
        repoURL: https://github.com/christianh814/gitops-examples
        targetRevision: main
        path: '{{path}}'
      destination:
        server: https://kubernetes.default.svc
        namespace: pricelist
```

### Use cases

The following use cases should be implemented for the conclusion of this
proposal:

#### [UC-1]: As a user, I would like to configure deletion strategy
Implementing deletion sync configuration will allow users to configure dependencies for the application removal process.

### Implementation Details/Notes/Constraints [optional]

TBD

### Detailed examples

### Security Considerations

TBD

### Risks and Mitigations

TBD

### Upgrade / Downgrade Strategy

TBD

## Drawbacks

- Slight increase in Argo CD code base complexity.

## Alternatives

TBD